% !TeX root = report_example.tex
\newcommand*{\MyHeaderPath}{.}% This path definition is also passed to inside the header files.
\newcommand*{\PathToAssets}{../assets}%
\newcommand*{\PathToOutput}{../output}%
\newcommand*{\PathToBibFile}{bibliography.bib}%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% This file is compiled with XeLaTex.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\input{\MyHeaderPath/_article_header.tex}
\input{\MyHeaderPath/_lean_header.tex}



\input{\PathToOutput/latexVar.tex}
%\STARTONE
%\ENDONE
%\STARTTWO
%\ENDTWO

\begin{document}

\pagenumbering{gobble}


\title{
The Puzzle of Filtering Index Options
\\{\color{blue} \large UChicago WI 24: FINN 329\footnote{Taught by Jeremy Bejarano, jbejarano@uchicago.edu }}
}
% {\color{blue} \large Preliminary. Do not distribute.}
% }

\author{
Viren Desai, Harrison Holt, Ian Hammock 
  % \newline 
  % \hspace{3pt} \indent \hspace{3pt}
  % % I am immensely grateful to...
}
% \maketitle

\begin{titlepage}

% \input{cover_letter.tex}
\maketitle
%http://tex.stackexchange.com/questions/141446/problem-of-duplicate-identifier-when-using-bibentry-and-hyperref
%https://stackoverflow.com/questions/51225448/can-i-make-the-entire-table-1-clickable-as-a-reference-in-latex
% \nobibliography*

% Abstract should have fewer than 150 words

\doublespacing
\begin{abstract}
In this article we will summarize our efforts to replicate the filtering described in appendix B of \textit{The Puzzle of Index Option Returns} by \citet{constantinides2013}. We provide additional insight on how these filters shape the distribution on implied volatility and moneyness. Moreover, due to the unavailability of index option data from 1985 to 1995, we focus our comparison on the dataset of \STARTONE\  to \ENDONE\ as well as extending this analysis forward from \STARTTWO\  to \ENDTWO. Our analysis can be readily found on our \href{https://github.com/harrypandas/finm-32900_final_project.git}{Github} \footnote{ \url{https://github.com/harrypandas/finm-32900_final_project.git} }.  


\end{abstract}


\end{titlepage}

\doublespacing


\pagenumbering{arabic}
\section{Replicating Table B1}

In the appendix B of \citet{constantinides2013}, three levels of filters are described with the intent to minimize quoting errors in the construction of their portfolios. In this section we will summarize our implementation and briefly discuss the differences. Our results are summarized in \autoref{table:tableB1}. Furthe discussion relating to the distribution of implied volatility and moneyness through the level three filter can be found in the \autoref{app:lvl3}.

\subsection{Level 1} 
Two issues arose when applying this set of filters. Firstly, there are quite a few options in the "Identical but Price" filter that have no implied volatility. This will be taken care in level two, but knowledge of the implied volatility is required to select the option's price that has volatility closest to the "at the money" volatility. This is limited to about 5 in the 1996-2012 dataset, and most of these options will fall out in the level 2 filters (days to expiration <7 or out of the money. In the 2012 to 2019 dataset we have observed around 355,896 options with no implied volatility. The distribution of expiration time and moneyness peak is  given in. For the purpose of this filter, if an implied volatility is not given it will not be choosen as the option with volatility closest to the at the money,as we will be unable to calculate it and it will fall out in level 2. Additionally, if an option family's "at the money" member cannot have their implied volatilitiy calculated all options will be inevitably dropped due to the "Unable to compute IV" filter. 

Secondly, an unexplainable difference occurs upon the application of the Volume = 0 filter. In Table B1 of \citet{constantinides2013}, no options have a Volume = 0 in their dataset. However, we observe 2,093,744 options with a Volume = 0. Unfortunately, no more details are given in the manuscript describing this step. In order to not diverge from their data pool we choose to drop 0 options, this is reflected in \autoref{table:tableB1}.


\subsection {Level 2}

\subsection{Level 3} 

\newpage 

\thispagestyle{empty}
\begin{landscape}

\begin{table}

\centering
 \captionsetup{font={Large}}
\caption{Table B.1}
\resizebox{1.4\textwidth}{!}{
\hspace*{-4cm}
\input{\PathToOutput/tableB1.tex}
}
\caption*{
  Number of observations that are removed upon application of appendix B filters. 
}
\label{table:tableB1}
\end{table}

\vfill
\raisebox{-4cm}{\makebox[\linewidth]{\thepage}}
\end{landscape}
\newpage






\section{Replicating Table2}
\autoref{tab:t2} describes how many options are found, go missing, or expire in the dataset. An option is found if it reappears the next trading day. An option is missing for if it does not reappear the next trading day. Multiple days missing, counts as multiple options missing. Lastly, if an option is lost and expires this is noted as expired. 

We would like to note an interesting aspect of this dataset. Over 80\% of the options expire on a Saturday or a non-trading day. To handle this, we push the expiration day to the nearest Friday, presumably the nearest trading day. However, there are quite a few edge cases which would explain the discrepancy between our analysis and \citet{constantinides2013}. Further investigation is required. 

%To implement this table we use pandas market calendars to produce an array of NYSE trading days. We then assign an integer to each day and merge this to our dataframe. To determine the time an option is lost, we use a relative distance argument and take differences using the integers. This is much faster than subtracting datetime objects with conditionals on if we're getting a trading day. adf




\newpage 

\thispagestyle{empty}
\begin{landscape}

\begin{table}
    \centering
   \captionsetup{font={Large}}
    \caption{ Table 2 Sample}
    
\resizebox{1.4\textwidth}{!}{
\hspace*{-4cm}
  \input{\PathToOutput/table2.tex}
  }

  \caption*{Tracking the instances options are found, missing or expired.}
\label{tab:t2}
\end{table}
\vfill
\raisebox{-6.5cm}{\makebox[\linewidth]{\thepage}}
\end{landscape}
\newpage



\section{Data}

Our option data is queried from OptionMetrics provided by Wharton Research Data Services (WRDS). We limit the query to SECID = 108105, S\&P 500 Index - SPX. We use the three month Tbill as our interest rate, this is from the Federal Reserve Board's H15 report supplied by WRDS. 

In comparison to their data, we have pulled 184 more options than them. It is unclear where the discrepancy lies. We assumed we were off by a day however this will truncate or elongate the dataset by over 300 points. We credit the discrepancy to OptionMetrics updating their data to be more accurate. 

The following links contain the documentation and helpful links for the WRDS database: 
\begin{itemize}
\item \href{https://wrds-www.wharton.upenn.edu/pages/support/manuals-and-overviews/optionmetrics/wrds-overview-optionmetrics/}{Option Metrics Overview} 
\item \href{https://wrds-www.wharton.upenn.edu/data-dictionary/optionm_all/opprcd2023/ }{Option Metric Keys}
\item \href{https://wrds-www.wharton.upenn.edu/pages/get-data/optionmetrics/ivy-db-us/options/option-prices/}{Option Metrics Query} 
\item \href{https://wrds-www.wharton.upenn.edu/data-dictionary/frb_all/rates_daily/}{Federal Reserve Report} 
\end{itemize}






\newpage
\bibliographystyle{jpe}
\bibliography{bibliography.bib}  % list here all the bibliographies that you need. 
% \bibliography{\PathToBibFile}
% \printbibliography

\newpage

\begin{appendix}


\section{Level Three Filter}\label{app:lvl3}
\subsection{\STARTONE\ to \ENDONE }

\begin{figure}[H] % You can adjust the placement options (htbp) as needed
  \centering
  \includegraphics[width=\textwidth]{\PathToOutput/L3_\STARTONE_\ENDONE_fig1_post_L2filter.png}%{\PathToOutput/pdf_temp.pdf}
  \caption{Your caption here}
  \label{fig:your_label}
\end{figure}


\begin{figure}[H] % You can adjust the placement options (htbp) as needed
  \centering
  \includegraphics[width=\textwidth]{\PathToOutput/L3_\STARTONE_\ENDONE_fig2_L2fitted_iv.png}%{\PathToOutput/pdf_temp.pdf}
  \caption{Your caption here}
  \label{fig:your_label}
\end{figure}


\begin{figure}[H] % You can adjust the placement options (htbp) as needed
  \centering
  \includegraphics[width=\textwidth]{\PathToOutput/L3_\STARTONE_\ENDONE_fig3_IV_filter_only.png}%{\PathToOutput/pdf_temp.pdf}
  \caption{Your caption here}
  \label{fig:your_label}
\end{figure}


\begin{figure}[H] % You can adjust the placement options (htbp) as needed
  \centering
  \includegraphics[width=\textwidth]{\PathToOutput/L3_\STARTONE_\ENDONE_fig4_IV_and_PCP.png}%{\PathToOutput/pdf_temp.pdf}
  \caption{Your caption here}
  \label{fig:your_label}
\end{figure}

\newpage
\subsection{\STARTTWO\ to \ENDTWO }

\begin{figure}[H] % You can adjust the placement options (htbp) as needed
  \centering
  \includegraphics[width=\textwidth]{\PathToOutput/L3_\STARTTWO_\ENDTWO_fig1_post_L2filter.png}%{\PathToOutput/pdf_temp.pdf}
  \caption{Your caption here}
  \label{fig:your_label}
\end{figure}


\begin{figure}[H] % You can adjust the placement options (htbp) as needed
  \centering
  \includegraphics[width=\textwidth]{\PathToOutput/L3_\STARTTWO_\ENDTWO_fig2_L2fitted_iv.png}%{\PathToOutput/pdf_temp.pdf}
  \caption{Your caption here}
  \label{fig:your_label}
\end{figure}


\begin{figure}[H] % You can adjust the placement options (htbp) as needed
  \centering
  \includegraphics[width=\textwidth]{\PathToOutput/L3_\STARTTWO_\ENDTWO_fig3_IV_filter_only.png}%{\PathToOutput/pdf_temp.pdf}
  \caption{Your caption here}
  \label{fig:your_label}
\end{figure}


\begin{figure}[H] % You can adjust the placement options (htbp) as needed
  \centering
  \includegraphics[width=\textwidth]{\PathToOutput/L3_\STARTTWO_\ENDTWO_fig4_IV_and_PCP.png}%{\PathToOutput/pdf_temp.pdf}
  \caption{Your caption here}
  \label{fig:your_label}
\end{figure}

\newpage


\end{appendix}

\end{document}
